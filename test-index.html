<!DOCTYPE html>
<html>
<head>
    <title>WebAR —Å YouTube —Ä–∏–∫—Ä–æ–ª–ª–æ–º</title>
    <style>
        body { 
            margin: 0; 
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        #camera-video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: black;
        }
        #ar-canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        #youtube-container {
            position: absolute;
            width: 320px;
            height: 180px;
            z-index: 20;
            border: 2px solid red;
            display: none;
            pointer-events: none;
        }
        #youtube-player {
            width: 100%;
            height: 100%;
            border: none;
        }
        #debug-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 400px;
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
        }
        button:hover {
            background: #0056cc;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .hidden {
            display: none !important;
        }
        .marker-overlay {
            position: absolute;
            width: 100px;
            height: 100px;
            border: 3px dashed #00ff00;
            background: rgba(0, 255, 0, 0.1);
            z-index: 15;
            display: none;
        }
        #load-status {
            margin-top: 20px;
            color: #888;
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <h1>üé¨ WebAR YouTube –†–∏–∫—Ä–æ–ª–ª</h1>
        <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä/QR-–∫–æ–¥</p>
        <button id="start-button" disabled>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫...</button>
        <div id="load-status">–ó–∞–≥—Ä—É–∂–∞–µ–º Three.js –∏ YouTube API...</div>
    </div>

    <div id="container">
        <video id="camera-video" playsinline></video>
        <canvas id="ar-canvas"></canvas>
        <div id="youtube-container">
            <iframe id="youtube-player" 
                    src="https://www.youtube.com/embed/dQw4w9WgXcQ?enablejsapi=1&controls=0&modestbranding=1&rel=0&showinfo=0&autoplay=1&mute=1&loop=1&playlist=dQw4w9WgXcQ"
                    frameborder="0" 
                    allow="autoplay; encrypted-media" 
                    allowfullscreen>
            </iframe>
        </div>
        <div class="marker-overlay" id="marker-overlay"></div>
        <div id="debug-info">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</div>
    </div>

    <!-- –∑–∞–≥—Ä—É–∂–∞–µ–º Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r160/three.min.js"></script>
    <!-- –∑–∞–≥—Ä—É–∂–∞–µ–º YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        // –∂–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
        let threeLoaded = false;
        let youtubeLoaded = false;
        
        // –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É Three.js
        if (typeof THREE !== 'undefined') {
            threeLoaded = true;
            updateStartButton();
        } else {
            // –µ—Å–ª–∏ Three.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
            const backupScript = document.createElement('script');
            backupScript.src = 'https://unpkg.com/three@0.160.0/build/three.min.js';
            backupScript.onload = function() {
                threeLoaded = true;
                updateStartButton();
            };
            backupScript.onerror = function() {
                document.getElementById('load-status').innerHTML = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Three.js';
            };
            document.head.appendChild(backupScript);
        }
        
        // youtube API –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –∫–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω
        function onYouTubeIframeAPIReady() {
            youtubeLoaded = true;
            updateStartButton();
        }
        
        // o–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–Ω–æ–ø–∫–∏
        function updateStartButton() {
            const startButton = document.getElementById('start-button');
            const loadStatus = document.getElementById('load-status');
            
            if (threeLoaded && youtubeLoaded) {
                startButton.disabled = false;
                startButton.textContent = "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å AR";
                loadStatus.innerHTML = "‚úÖ –í—Å–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!";
            } else {
                let status = "–ó–∞–≥—Ä—É–∂–∞–µ–º: ";
                if (!threeLoaded) status += "Three.js ";
                if (!youtubeLoaded) status += "YouTube API ";
                loadStatus.innerHTML = status;
            }
        }
        
        // –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ–≥–¥–∞ –≤—Å–µ –≥–æ—Ç–æ–≤–æ
        document.addEventListener('DOMContentLoaded', function() {
            const startButton = document.getElementById('start-button');
            const startScreen = document.getElementById('start-screen');
            const debugInfo = document.getElementById('debug-info');
            
            let arApp = null;
            
            startButton.addEventListener('click', async function() {
                // —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ THREE –¥–æ—Å—Ç—É–ø–Ω–∞
                if (typeof THREE === 'undefined') {
                    debugInfo.innerHTML = "‚ùå THREE –≤—Å–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
                    return;
                }
                
                startScreen.classList.add('hidden');
                debugInfo.innerHTML = "üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebAR...";
                
                try {
                    arApp = new YouTubeAR();
                    await arApp.init();
                } catch (error) {
                    debugInfo.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`;
                    console.error(error);
                }
            });
        });

        class YouTubeAR {
            constructor() {
                this.videoElement = document.getElementById('camera-video');
                this.canvas = document.getElementById('ar-canvas');
                this.debugInfo = document.getElementById('debug-info');
                this.youtubeContainer = document.getElementById('youtube-container');
                this.youtubePlayer = null;
                this.markerOverlay = document.getElementById('marker-overlay');
                
                this.isTracking = false;
                this.markerPosition = { x: 0, y: 0, width: 100, height: 100 };
            }
            
            async init() {
                try {
                    // 1. –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–º–µ—Ä—É
                    await this.startCamera();
                    this.debugInfo.innerHTML = "‚úÖ –ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞<br>üîç –ò—â–µ–º –º–∞—Ä–∫–µ—Ä—ã...";
                    
                    // 2. –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Three.js –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                    this.initThreeJS();
                    this.debugInfo.innerHTML += "<br>‚úÖ Three.js –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω";
                    
                    // 3. –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º YouTube –ø–ª–µ–µ—Ä
                    await this.initYouTube();
                    this.debugInfo.innerHTML += "<br>‚úÖ YouTube –ø–ª–µ–µ—Ä –≥–æ—Ç–æ–≤";
                    
                    // 4. –∑–∞–ø—É—Å–∫–∞–µ–º –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
                    this.startMarkerDetection();
                    
                    this.debugInfo.innerHTML += "<br><br>üéØ <strong>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong>";
                    this.debugInfo.innerHTML += "<br>1. üì± –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É";
                    this.debugInfo.innerHTML += "<br>2. üî≤ –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥/–º–∞—Ä–∫–µ—Ä";
                    this.debugInfo.innerHTML += "<br>3. üé¨ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Ä–∏–∫—Ä–æ–ª–ª!";
                    
                } catch (error) {
                    this.debugInfo.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                    console.error(error);
                    throw error;
                }
            }
            
            async startCamera() {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                this.videoElement.srcObject = stream;
                
                return new Promise((resolve) => {
                    this.videoElement.onloadedmetadata = () => {
                        this.videoElement.play().then(resolve);
                    };
                });
            }
            
            initThreeJS() {
                // –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ THREE –¥–æ—Å—Ç—É–ø–Ω–∞
                if (typeof THREE === 'undefined') {
                    throw new Error("THREE –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
                }
                
                // —Å–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é Three.js —Å—Ü–µ–Ω—É –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ 
                    canvas: this.canvas,
                    alpha: true,
                    antialias: true
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setClearColor(0x000000, 0);

                this.animate();
            }
            
            initYouTube() {
                return new Promise((resolve) => {
                    // YouTube API —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω
                    if (window.YT && window.YT.Player) {
                        this.createYouTubePlayer(resolve);
                    } else {
                        // –∏–Ω–∞—á–µ –∂–¥–µ–º
                        const checkYouTube = setInterval(() => {
                            if (window.YT && window.YT.Player) {
                                clearInterval(checkYouTube);
                                this.createYouTubePlayer(resolve);
                            }
                        }, 100);
                    }
                });
            }
            
            createYouTubePlayer(resolve) {
                this.youtubePlayer = new YT.Player('youtube-player', {
                    events: {
                        'onReady': () => {
                            resolve();
                        },
                        'onStateChange': (event) => {
                            if (event.data === YT.PlayerState.PLAYING) {
                                this.debugInfo.innerHTML += "<br>üé¨ –†–∏–∫—Ä–æ–ª–ª –∑–∞–ø—É—â–µ–Ω!";
                            }
                        }
                    }
                });
            }
            
            startMarkerDetection() {
                // –∏–º–∏—Ç–∞—Ü–∏—è –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏                
                this.simulateMarkerDetection();
            }
            
            simulateMarkerDetection() {
                // —Å–∏–º—É–ª—è—Ü–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
                let markerVisible = false;
                let checkCount = 0;
                
                const checkMarker = () => {
                    checkCount++;
                    
                    // —Å–∏–º—É–ª—è—Ü–∏—è: –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã "–Ω–∞—Ö–æ–¥–∏–º" –º–∞—Ä–∫–µ—Ä
                    if (checkCount % 60 === 0) { // –ø—Ä–∏–º–µ—Ä–Ω–æ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–∏ 20fps
                        if (!markerVisible) {
                            this.onMarkerFound();
                            markerVisible = true;
                        }
                    } else if (markerVisible && checkCount % 120 === 0) {
                        this.onMarkerLost();
                        markerVisible = false;
                    }
                    
                    // –µ—Å–ª–∏ –º–∞—Ä–∫–µ—Ä –≤–∏–¥–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
                    if (markerVisible) {
                        this.updateMarkerPosition();
                    }
                    
                    requestAnimationFrame(checkMarker);
                };
                
                checkMarker();
            }
            
            onMarkerFound() {
                if (!this.isTracking) {
                    this.isTracking = true;
                    this.debugInfo.innerHTML += "<br>üéØ –ú–∞—Ä–∫–µ—Ä –æ–±–Ω–∞—Ä—É–∂–µ–Ω! –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∏–∫—Ä–æ–ª–ª...";
                    
                    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º YouTube –≤–∏–¥–µ–æ
                    this.youtubeContainer.style.display = 'block';
                    this.markerOverlay.style.display = 'block';
                    
                    // –∑–∞–ø—É—Å–∫–∞–µ–º –≤–∏–¥–µ–æ
                    if (this.youtubePlayer && this.youtubePlayer.playVideo) {
                        this.youtubePlayer.playVideo();
                    }
                }
            }
            
            onMarkerLost() {
                if (this.isTracking) {
                    this.isTracking = false;
                    this.debugInfo.innerHTML += "<br>üëã –ú–∞—Ä–∫–µ—Ä –ø–æ—Ç–µ—Ä—è–Ω";
                    
                    // —Å–∫—Ä—ã–≤–∞–µ–º YouTube –≤–∏–¥–µ–æ
                    this.youtubeContainer.style.display = 'none';
                    this.markerOverlay.style.display = 'none';
                    
                    // –ø–∞—É–∑–∏–º –≤–∏–¥–µ–æ
                    if (this.youtubePlayer && this.youtubePlayer.pauseVideo) {
                        this.youtubePlayer.pauseVideo();
                    }
                }
            }
            
            updateMarkerPosition() {
                if (!this.isTracking) return;
                // –ø—Ä–æ—Å—Ç–æ –¥–≤–∏–≥–∞–µ–º –º–∞—Ä–∫–µ—Ä –ø–æ —ç–∫—Ä–∞–Ω—É –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                const time = Date.now() * 0.001;
                const centerX = window.innerWidth / 2 - 50;
                const centerY = window.innerHeight / 2 - 50;
                // –ª–µ–≥–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–∫–∏–Ω–≥–∞
                const offsetX = Math.sin(time) * 100;
                const offsetY = Math.cos(time * 0.7) * 50;
                
                this.markerPosition.x = centerX + offsetX;
                this.markerPosition.y = centerY + offsetY;
                
                // –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é YouTube –≤–∏–¥–µ–æ –∏ –æ–≤–µ—Ä–ª–µ—è
                this.youtubeContainer.style.left = this.markerPosition.x + 'px';
                this.youtubeContainer.style.top = this.markerPosition.y + 'px';
                
                this.markerOverlay.style.left = this.markerPosition.x + 'px';
                this.markerOverlay.style.top = this.markerPosition.y + 'px';

                const scale = 1 + Math.sin(time * 2) * 0.1;
                this.youtubeContainer.style.transform = `scale(${scale})`;
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è Three.js —Å—Ü–µ–Ω—ã
                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
            }
        }
    </script>
</body>
</html>