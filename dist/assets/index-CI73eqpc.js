(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const d=window.THREE;class E{constructor(e={}){this.config=e,this.loadedAssets=new Map,this.loadingPromises=new Map}async loadVideoTexture(e,t,o={}){if(this.loadedAssets.has(t))return this.loadedAssets.get(t);if(this.loadingPromises.has(t))return this.loadingPromises.get(t);const s=this._loadVideoTextureInternal(e,t,o);this.loadingPromises.set(t,s);try{const i=await s;return this.loadedAssets.set(t,i),i}finally{this.loadingPromises.delete(t)}}async _loadVideoTextureInternal(e,t,o){return new Promise((s,i)=>{const r=document.createElement("video");r.muted=o.muted??!0,r.loop=o.loop??!0,r.playsInline=!0,r.crossOrigin="anonymous";const n=new d.VideoTexture(r);n.minFilter=d.LinearFilter,n.magFilter=d.LinearFilter,n.format=d.RGBAFormat;const m=()=>{p(),o.autoplay&&r.play().catch(l=>console.warn("Video autoplay failed:",l)),s({videoElement:r,texture:n})},g=l=>{p(),i(new Error(`Failed to load video "${t}" from ${e}: ${l.message||"Unknown error"}`))},p=()=>{r.removeEventListener("canplay",m),r.removeEventListener("error",g)};r.addEventListener("canplay",m,{once:!0}),r.addEventListener("error",g,{once:!0}),r.src=e,r.load(),setTimeout(()=>{!this.loadedAssets.has(t)&&!r.played&&(p(),i(new Error(`Video loading timeout for "${t}"`)))},3e4)})}createVideoMesh(e,t={}){const s={...{geometry:{width:1.6,height:.9,widthSegments:1,heightSegments:1},position:{x:0,y:.45,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},...t},{geometry:i,position:r,rotation:n,scale:m}=s,g=new d.PlaneGeometry(i.width,i.height,i.widthSegments,i.heightSegments),p=new d.MeshBasicMaterial({map:e,transparent:!1,opacity:1,side:d.FrontSide}),l=new d.Mesh(g,p);l.position.set(r.x,r.y,r.z),l.rotation.order="XYZ",l.rotation.set(n.x,n.y,n.z),l.scale.set(m.x,m.y,m.z);const y=e.source?.data||e.image;return y&&(l.userData.videoElement=y),l}playVideo(e){const t=e.userData.videoElement;t&&t.paused&&t.play().catch(o=>console.warn("Play failed:",o))}pauseVideo(e){const t=e.userData.videoElement;t&&!t.paused&&t.pause()}stopVideo(e){const t=e.userData.videoElement;t&&(t.pause(),t.currentTime=0)}setVolume(e,t){const o=e.userData.videoElement;o&&(o.volume=Math.max(0,Math.min(1,t)))}dispose(e){const t=this.loadedAssets.get(e);t&&(t.videoElement&&(t.videoElement.pause(),t.videoElement.src=""),t.texture&&t.texture.dispose(),this.loadedAssets.delete(e))}disposeAll(){for(const e of this.loadedAssets.keys())this.dispose(e)}}const c={type:"hiro",patternUrl:"https://cdn.rawgit.com/jeromeetienne/AR.js/master/data/data/patt.hiro",cameraParametersUrl:"https://cdn.rawgit.com/jeromeetienne/AR.js/master/data/data/camera_para.dat",detectionMode:"mono",matrixCodeType:"3x3",canvasWidth:1280,canvasHeight:720},u={primary:{name:"rickroll",url:"./videos/rickroll.mp4",loop:!0,muted:!0,autoplay:!1,volume:.5},fallback:{name:"placeholder",url:"https://www.w3schools.com/html/mov_bbb.mp4",loop:!0,muted:!0,autoplay:!1}},M={geometry:{width:.16,height:.09,widthSegments:1,heightSegments:1},position:{x:0,y:0,z:.1},rotation:{x:-Math.PI/2,y:0,z:0},scale:{x:1,y:1,z:1}},h={ambient:{color:16777215,intensity:.8},directional:{color:16777215,intensity:.5,position:{x:5,y:5,z:5}}},f={fov:60,near:.1,far:1e3},a=window.THREE||window.THREEx&&window.THREEx.THREE;class v{constructor(){this.container=document.getElementById("ar-container"),this.statusText=document.getElementById("status-text"),this.markerStatus=document.getElementById("marker-status"),this.videoStatus=document.getElementById("video-status"),this.fpsCounter=document.getElementById("fps"),this.scene=null,this.camera=null,this.renderer=null,this.arToolkitSource=null,this.arToolkitContext=null,this.markerGroup=null,this.assetLoader=new E,this.videoMesh=null,this.isMarkerDetected=!1,this.frameCount=0,this.lastFpsUpdate=Date.now(),this.errorLogged=!1,this.waitForARJS()}async waitForARJS(){let e=0;const t=100;for(;e<t;){const o=typeof window.THREEx<"u",s=typeof window.ARController<"u",i=typeof window.ARCameraParam<"u",r=typeof window.THREE<"u"||window.THREEx&&window.THREEx.THREE;if(o&&s&&i&&r){console.log("âœ… AR.js loaded successfully"),console.log("   THREE:",!!window.THREE),console.log("   THREEx:",!!window.THREEx),console.log("   ARController:",!!window.ARController),console.log("   ARCameraParam:",!!window.ARCameraParam),!window.THREE&&window.THREEx&&window.THREEx.THREE&&(window.THREE=window.THREEx.THREE),await this.init();return}await new Promise(n=>setTimeout(n,50)),e++}throw console.error("âŒ AR.js libraries failed to load after 5 seconds"),console.error("Available globals:",{THREE:typeof window.THREE,THREEx:typeof window.THREEx,ARController:typeof window.ARController,ARCameraParam:typeof window.ARCameraParam}),new Error("AR.js libraries not loaded")}async init(){try{console.log("ðŸš€ Starting ARApp initialization..."),this.updateStatus("Initializing AR.js...","loading"),console.log("ðŸ“ Initializing Three.js scene..."),this.initThreeJS(),console.log("âœ… Three.js scene initialized"),console.log("ðŸ“· Checking camera access..."),await this.checkCameraAccess(),console.log("âœ… Camera access verified"),this.updateStatus("Setting up marker detection...","loading"),console.log("ðŸ” Initializing AR.js marker detection..."),await this.initARJS(),console.log("âœ… AR.js initialized successfully"),this.updateStatus("Loading video assets...","loading"),console.log("ðŸŽ¬ Loading video assets..."),await this.loadVideoAssets(),console.log("âœ… Video assets loaded"),console.log("â–¶ï¸ Starting animation loop..."),this.updateStatus("Ready","ok"),this.animate(),console.log("âœ… ARApp fully initialized and running")}catch(e){console.error("âŒ Initialization failed:",e),console.error("Error stack:",e.stack),this.updateStatus(`Error: ${e.message}`,"error")}}async checkCameraAccess(){try{if(console.log("ðŸ” Requesting camera permissions..."),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("getUserMedia not supported in this browser");console.log("âœ… getUserMedia API available");const e={video:{facingMode:"environment",width:{ideal:c.canvasWidth},height:{ideal:c.canvasHeight}}};console.log("ðŸ“¹ Requesting camera with constraints:",e);const t=await navigator.mediaDevices.getUserMedia(e);console.log("âœ… Camera permission granted!"),console.log("ðŸ“Š Stream tracks:",t.getTracks()),t.getTracks().forEach(o=>{console.log(`â¹ï¸ Stopping track: ${o.kind} (${o.label})`),o.stop()}),console.log("âœ… Camera access confirmed, stream closed")}catch(e){throw console.error("âŒ Camera access error:",e.message),console.error("Possible causes:"),console.error("  - Browser doesn't support camera access"),console.error("  - User denied camera permission"),console.error("  - No camera device available"),console.error("  - HTTPS/localhost required for camera"),e}}initThreeJS(){this.scene=new a.Scene;const e=window.innerWidth,t=window.innerHeight;this.camera=new a.PerspectiveCamera(f.fov,e/t,f.near,f.far),this.renderer=new a.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.renderer.setSize(e,t),this.renderer.setClearColor(0,0),this.renderer.domElement.style.position="absolute",this.renderer.domElement.style.top="0",this.renderer.domElement.style.left="0",this.renderer.domElement.style.zIndex="1",this.container.appendChild(this.renderer.domElement);const o=new a.AmbientLight(h.ambient.color,h.ambient.intensity);this.scene.add(o);const s=new a.DirectionalLight(h.directional.color,h.directional.intensity);s.position.set(h.directional.position.x,h.directional.position.y,h.directional.position.z),this.scene.add(s),this.markerGroup=new a.Group,this.markerGroup.name="markerRoot",this.scene.add(this.markerGroup),window.addEventListener("resize",()=>this.onWindowResize())}async createSimpleVideo(){const e=document.createElement("video");e.src="./videos/rickroll.mp4",e.loop=!0,e.muted=!0,e.playsInline=!0,await new Promise(r=>{e.oncanplay=r});const t=new a.VideoTexture(e),o=new a.PlaneGeometry(2,1.125),s=new a.MeshBasicMaterial({map:t}),i=new a.Mesh(o,s);i.position.z=-.3,this.scene.add(i),e.play(),console.log("âœ… Simple video added to scene")}async initARJS(){try{console.log("ðŸ”§ Initializing AR.js 2.2.2 with THREEx...");const e=document.createElement("canvas");e.id="arjs-canvas",e.width=c.canvasWidth,e.height=c.canvasHeight,e.style.display="block",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.zIndex="0",this.container.insertBefore(e,this.container.firstChild),this.arCanvas=e,console.log("ðŸ“· Loading camera parameters..."),this.cameraParam=new ARCameraParam(c.cameraParametersUrl),await new Promise(o=>{this.cameraParam.onload=()=>{console.log("âœ… Camera parameters loaded"),o()},setTimeout(()=>{console.log("âœ… Camera parameters loaded (or using defaults)"),o()},1e3)}),console.log("ðŸŽ® Creating ARController..."),this.arController=new ARController(e.width,e.height,this.cameraParam),console.log("âœ… ARController created"),console.log("ðŸ“¹ Getting video stream...");const t={video:{facingMode:"environment",width:{ideal:c.canvasWidth},height:{ideal:c.canvasHeight}}};try{this.videoStream=await navigator.mediaDevices.getUserMedia(t),console.log("âœ… Video stream acquired");const o=document.createElement("video");o.setAttribute("autoplay",!0),o.setAttribute("playsinline",!0),o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.zIndex="-1",o.style.transform="scaleX(-1)",this.container.insertBefore(o,this.arCanvas),o.srcObject=this.videoStream,this.videoElement=o,await new Promise(s=>{o.onloadedmetadata=()=>{o.play(),console.log("âœ… Video element ready and playing"),s()},setTimeout(s,2e3)})}catch(o){console.warn("âš ï¸ Could not get video stream:",o.message)}console.log(`ðŸŽ¯ Setting up marker detection (${c.type})...`),console.log("   âœ… Hiro marker detection enabled"),console.log("ðŸŽ¬ Configuring camera projection..."),console.log("âœ… Camera projection configured"),console.log("âœ… AR.js initialization complete")}catch(e){throw console.error("âŒ AR.js initialization error:",e),console.error("Error details:",e.message),console.error("Stack:",e.stack),e}}setupMarkerDetection(){console.log("ðŸŽ¯ Marker detection setup complete")}async loadVideoAssets(){try{console.log("ðŸŽ¥ Loading primary video asset..."),console.log(`   URL: ${u.primary.url}`),console.log("   Config:",u.primary);const e=await this.assetLoader.loadVideoTexture(u.primary.url,u.primary.name,{muted:u.primary.muted,loop:u.primary.loop,autoplay:!1});console.log("âœ… Primary video loaded successfully"),console.log("   Video element:",e.videoElement),console.log("   Texture:",e.texture),console.log("ðŸŽ¨ Creating video mesh..."),this.videoMesh=this.assetLoader.createVideoMesh(e.texture,M),this.videoMesh.visible=!1,this.markerGroup.add(this.videoMesh),console.log("âœ… Video mesh created and added to marker group"),this.updateVideoStatus("Ready"),console.log("âœ… Video assets fully loaded and ready")}catch(e){throw console.error("âŒ Failed to load video:",e),console.error("   Error message:",e.message),console.error("   Stack:",e.stack),this.updateVideoStatus(`Load failed: ${e.message}`),e}}onMarkerFound(){console.log("ðŸŽ‰ âœ… MARKER DETECTED!"),this.updateMarkerStatus("Detected","found"),this.videoMesh?(console.log("ðŸ“º Making video mesh visible and playing..."),this.videoMesh.visible=!0,this.assetLoader.playVideo(this.videoMesh),this.updateVideoStatus("Playing"),console.log("â–¶ï¸ Video started playing")):console.warn("âš ï¸ Video mesh not initialized")}onMarkerLost(){console.log("âŒ Marker lost"),this.updateMarkerStatus("Not detected","lost"),this.videoMesh?(console.log("â¸ï¸ Pausing video and hiding mesh..."),this.videoMesh.visible=!1,this.assetLoader.pauseVideo(this.videoMesh),this.updateVideoStatus("Paused"),console.log("â¹ï¸ Video paused")):console.warn("âš ï¸ Video mesh not initialized")}animate=()=>{requestAnimationFrame(this.animate);try{if(this.arController&&this.videoElement&&this.videoElement.readyState===this.videoElement.HAVE_ENOUGH_DATA){const e=this.arCanvas.getContext("2d");e&&e.drawImage(this.videoElement,0,0,this.arCanvas.width,this.arCanvas.height),this.arController.process(this.arCanvas);const t=new Float32Array(16);this.arController.getCameraMatrix(t),this.camera.projectionMatrix.fromArray(t),this.camera.projectionMatrixInverse.getInverse(this.camera.projectionMatrix);const o=this.arController.getMarkerNum();if(this.frameCount%30===0&&console.log(`ðŸ“ Markers detected: ${o}`),o>0&&this.markerGroup)try{const s=new Float32Array(16),i=this.arController.getTransMatSquare(0,80,s);console.log(`   getTransMatSquare success: ${i}`),i&&s.length>=16?(this.markerGroup.matrix||(this.markerGroup.matrix=new a.Matrix4),this.markerGroup.matrix.fromArray(s),this.markerGroup.matrixAutoUpdate=!1,this.markerGroup.visible=!0,this.videoMesh&&this.videoMesh.material&&this.videoMesh.material.map&&(this.videoMesh.material.map.needsUpdate=!0),this.isMarkerDetected||(this.isMarkerDetected=!0,console.log("ðŸŽ‰ MARKER FOUND!"),this.onMarkerFound())):this.isMarkerDetected&&(this.markerGroup.visible=!1,this.isMarkerDetected=!1,console.log("âŒ Marker lost (transform failed)"),this.onMarkerLost())}catch(s){this.frameCount%30===0&&console.log("   Outer error:",s.message),this.isMarkerDetected&&(this.markerGroup.visible=!1,this.isMarkerDetected=!1,this.onMarkerLost())}else this.markerGroup&&this.markerGroup.visible&&(this.markerGroup.visible=!1,this.isMarkerDetected&&(this.isMarkerDetected=!1,this.frameCount%30===0&&console.log("âŒ Marker lost (no detection)"),this.onMarkerLost()));this.videoMesh&&this.videoMesh.visible&&this.videoMesh.material&&this.videoMesh.material.map&&(this.videoMesh.material.map.needsUpdate=!0)}else this.frameCount%60===0&&console.log("âš ï¸ Cannot process frame:",{hasController:!!this.arController,hasVideo:!!this.videoElement,videoReady:this.videoElement?this.videoElement.readyState===this.videoElement.HAVE_ENOUGH_DATA:!1,videoReadyState:this.videoElement?this.videoElement.readyState:"N/A"});this.renderer&&this.renderer.render(this.scene,this.camera)}catch(e){this.errorLogged||(console.error("âŒ Animation loop error:",e.message),this.errorLogged=!0)}this.updateFPS()};updateFPS(){this.frameCount++;const e=Date.now(),t=e-this.lastFpsUpdate;if(t>=1e3){const o=Math.round(this.frameCount*1e3/t);this.fpsCounter.textContent=o,this.frameCount=0,this.lastFpsUpdate=e}}onWindowResize(){const e=window.innerWidth,t=window.innerHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.arToolkitSource&&this.arToolkitSource.onResize(),this.arToolkitContext&&this.arToolkitContext.update(this.arToolkitSource.domElement)}updateStatus(e,t="info"){this.statusText.textContent=e,this.statusText.className=t==="ok"?"marker-found":t==="error"?"marker-lost":"loading"}updateMarkerStatus(e,t="lost"){this.markerStatus.textContent=e,this.markerStatus.className=t==="found"?"marker-found":"marker-lost"}updateVideoStatus(e){this.videoStatus.textContent=e}dispose(){this.assetLoader.disposeAll(),this.renderer&&this.renderer.dispose()}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new v}):new v;
